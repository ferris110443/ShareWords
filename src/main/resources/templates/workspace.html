<!doctype html>
<html>
<head>
    <title>CRDT</title>
    <style>

    </style>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet">
    <link href="/src/pages/workspace.css" rel="stylesheet">
</head>
<body>

<div class="container">
    <div id="sidebar-placeholder"></div>

    <div class="mid-workspace ">
        <div class="content-section" id="room-zone">
            <h2>Workspace members</h2>
            <div id="userList">
                <div> Alice</div>
                <div> Bob</div>
                <div> Tony</div>
            </div>
            <h2> Add members</h2>
            <div id="add-friend-member">

            </div>
        </div>

        <div class="content-section" id="file-zone" style="display: none;">
            <h2>Existed Files</h2>
            <div id="fileList">
            </div>
        </div>
    </div>

    <div class="right-workspace">
        <h2>Creat New File</h2>
        <div id="create-new-file">
            <form id="file-creation-form">
                <div>
                    <label for="file-name-input">File Name</label>
                    <input aria-label="file-name-input" id="file-name-input" name="file" placeholder="Enter file name"
                           type="text">
                </div>
                <div>
                    <label for="file-description">File description</label>
                    <textarea aria-label="file-description" id="file-description" name="file-description"
                              placeholder="Enter file description"></textarea>
                </div>
                <button class="create-btn btn btn-primary" type="submit">Create File</button>
            </form>
        </div>
    </div>


</div>

<script crossorigin="anonymous"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.9/ace.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script crossorigin="anonymous"
        integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
        src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!--<script src="/lib/rga.js"></script>-->
<!--<script src="/src/pages/markdown.js"></script>-->
<!--<script src="/src/pages/socketIO.js" type="module"></script>-->
<script src="/src/components/AsideWorkspace.js"></script>
<script src="/src/pages/workspace.js"></script>

<script>
    const accessToken = localStorage.getItem('accessToken');
    const params = new URLSearchParams(window.location.search);
    const workspaceName = params.get('roomId');
    const queryParams = new URLSearchParams(window.location.search);
    const roomId = decodeURIComponent(queryParams.get('roomId'));

    renderWorkspaceFileList()
    getWorkspaceMember()
    getUserFriendsForAddingMembers()

    async function renderWorkspaceFileList() {
        const response = await fetch(`/api/1.0/workspace/workspace?workspaceName=${workspaceName}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            }
        })
        const data = await response.json();

        if (Array.isArray(data.data)) {
            let html = '';
            data.data.forEach((file, index) => {
                html += `
                    <div class="file-entry" id="file${index}">
                        <p>File Name: ${file.fileTitle}</p>
                        <p>File Description: ${file.fileDescription}</p>
                        <button aria-label="Edit File ${index}" class="edit-btn btn btn-primary " data-fileid="${file.fileId}">Edit</button>
                        <button aria-label="Delete File ${index}" class="delete-btn btn btn-danger" data-fileid="${file.fileId}">Delete</button>
                    </div>
                `;
            });
            document.getElementById("fileList").innerHTML += html;
            attachEditButtonListeners()
        } else {
            console.error('No files in workspace', data.data);
        }


        function attachEditButtonListeners() {
            const editButtons = document.querySelectorAll('.edit-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const fileId = this.getAttribute('data-fileid');
                    const editUrl = `http://localhost:3000/coeditor.html?roomId=${workspaceName}&fileId=${fileId}`;
                    window.location.href = editUrl;
                });
            });
        }


    }

    async function getWorkspaceMember() {
        try {
            const response = await fetch(`/api/1.0/workspace/workspaceMembers?workspaceName=${roomId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log(data.data)
            showWorkspaceMemberList(data.data);

        } catch (error) {
            console.error('Failed to update user:', error);
        }
    }


    async function getUserFriendsForAddingMembers() {
        try {
            // Fetch the current members of the workspace
            const membersResponse = await fetch(`/api/1.0/workspace/workspaceMembers?workspaceName=${roomId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
            });
            const membersData = await membersResponse.json();
            const currentMemberIds = new Set(membersData.data.map(member => member.userId));

            // Fetch user friends
            const friendsResponse = await fetch(`/api/1.0/user/friendsRelationShip`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
            });

            if (!friendsResponse.ok) {
                throw new Error(`HTTP error! status: ${friendsResponse.status}`);
            }

            const friendsData = await friendsResponse.json();
            const userFriendsInformation = friendsData.data;
            const userId = friendsData.userId;

            console.log(userFriendsInformation);
            console.log(userId);

            // Display friends who are not already in the workspace
            userFriendsInformation.forEach(item => {
                if ((userId === item.userId && item.status === 'accepted' && !currentMemberIds.has(item.friendId)) ||
                    (userId === item.friendId && item.status === 'accepted' && !currentMemberIds.has(item.userId))) {
                    const friendDiv = document.createElement('div');
                    friendDiv.classList.add('friend');
                    const friendName = userId === item.userId ? item.friendName : item.userName;
                    const friendEmail = userId === item.userId ? item.friendEmail : item.userEmail;
                    const friendId = userId === item.userId ? item.friendId : item.userId;
                    friendDiv.innerHTML = `
                    <div class ="friend-name">${friendName}</div>
                    <div class ="friend-email">${friendEmail}</div>
                    <button class="add-member-btn btn btn-primary">Add to Workspace</button>`;
                    const addButton = friendDiv.querySelector('.add-member-btn');
                    addButton.addEventListener('click', () => addFriendsToWorkspace(friendId));
                    document.getElementById('add-friend-member').appendChild(friendDiv);
                }
            });

        } catch (error) {
            console.error('Failed to fetch data:', error);
        }
    }

    function showWorkspaceMemberList(members) {
        const userListDiv = document.getElementById('userList');
        userListDiv.innerHTML = '';

        // Add new members to the list
        members.forEach(member => {
            const memberDiv = document.createElement('div');
            memberDiv.classList.add('member');
            memberDiv.innerHTML = `
                <div class ="workspace-member-name">${member.name}</div>
                <div class ="workspace-member-email">${member.email}</div>
            `;
            userListDiv.appendChild(memberDiv);
        });
    }

    async function addFriendsToWorkspace(userId) {
        try {
            const response = await fetch('/api/1.0/workspace/workspaceMembers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    userId: userId,
                    workspaceName: roomId
                })
            });

            const data = await response.json();

            if (!response.ok) {
                alert('Failed to add user to workspace: ' + data.error);
            } else {
                alert('User added to workspace successfully.');
                window.location.reload();
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add user to workspace.');
        }
    }


</script>


</body>
</html>
